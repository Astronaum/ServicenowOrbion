<?xml version="1.0" encoding="UTF-8"?><record_update table="sys_script_include">
    <sys_script_include action="INSERT_OR_UPDATE">
        <access>public</access>
        <active>true</active>
        <api_name>x_1539348_so.SCIMUserService </api_name>
        <caller_access/>
        <client_callable>true</client_callable>
        <description>To manage fetching users and roles and sending their patch</description>
        <mobile_callable>false</mobile_callable>
        <name>SCIMUserService </name>
        <sandbox_callable>false</sandbox_callable>
        <script><![CDATA[var SCIMUserService = Class.create();
SCIMUserService.prototype = Object.extendsObject(global.AbstractAjaxProcessor, {
    getUserInfo: function() {
        var response = {
            message: 'Error fetching user data',
            userData: []
        };

        try {
            var token = gs.getProperty('x_1539348_so.scim.api.token');
            if (!token) {
                gs.error('API token is missing in system properties.');
                return JSON.stringify(response);
            }

            var restMessage = new sn_ws.RESTMessageV2();
            var pageSize = 20; // Adjust this to match the SCIM API's max page size
            var startIndex = 0; // Start index for pagination
            var totalResults = 0; // To store total user count
            var hasMoreData = true;

            // Loop until all users are retrieved
            while (hasMoreData) {
                restMessage.setHttpMethod('GET');
                restMessage.setEndpoint('https://earth-apis.my.evidian.com/scim/v2/api/Users' +
                    '?startIndex=' + startIndex + '&count=' + pageSize);
                restMessage.setRequestHeader('Authorization', 'Bearer ' + token);

                var responseResult = restMessage.execute();
                var statusCode = responseResult.getStatusCode();
                var responseBody = responseResult.getBody();

                if (statusCode == 200) {
                    var parsedResponse = JSON.parse(responseBody);

                    // Append users from this page to the userData array
                    if (parsedResponse.Resources && parsedResponse.Resources.length > 0) {
                        parsedResponse.Resources.forEach(function(user) {
                            response.userData.push({
                                id: user.id,
                                userName: user.userName,
                                displayName: user.displayName,
                                email: user.emails?.[0]?.value || 'No Email',
                                roles: user.roles?.map(role => role.display) || []
                            });
                        });
                    }

                    // Set totalResults from the first response
                    if (totalResults === 0 && parsedResponse.totalResults) {
                        totalResults = parsedResponse.totalResults;
                    }

                    // Update startIndex for the next page
                    startIndex += pageSize;

                    // Check if we fetched all results
                    if (startIndex > totalResults) {
                        hasMoreData = false;
                    }
                } else {
                    gs.error('SCIM API call failed. Status: ' + statusCode);
                    response.message = 'Failed with status: ' + statusCode;
                    hasMoreData = false;
                }
            }

            response.message = 'Success';
        } catch (e) {
            response.message = 'Error: ' + e.message;
            gs.error('Error while fetching user data: ' + e.message);
        }
		gs.info('Final Response: ' + JSON.stringify(response));
        return JSON.stringify(response);
    },
	getRoles: function() {
    var roles = [];
    var gr = new GlideRecord('x_1539348_so_roles');
    gr.query();
    while (gr.next()) {
        roles.push({
            value: gr.getValue('value'),
            label: gr.getValue('droit')  // Ensure the correct field name for the role
        });
    }
    return JSON.stringify(roles);
	},
	addRoleToUser: function() {
        var userId = this.getParameter('user_id');  // Get the user ID from the request
        var roleSysId = this.getParameter('role');  // Get the role sys_id from the request
        
        var response = {
            success: false,
            message: 'Failed to add role to user.'
        };

        try {
            // Validate input
            if (!userId || !roleSysId) {
                response.message = 'User ID or Role Sys ID is missing.';
                return JSON.stringify(response);
            }

            // SCIM API URL for the user resource
            var scimUserUrl = 'https://earth-apis.my.evidian.com/scim/v2/api/Users/' + userId;

            // Construct the PATCH operation payload
            var patchPayload = {
                "schemas": ["urn:ietf:params:scim:api:messages:2.0:PatchOp"],
                "Operations": [
                    {
                        "op": "add",
                        "path": "roles",
                        "value": [
                            {
                                "value": roleSysId // Role sys_id to be added
                            }
                        ]
                    }
                ]
            };

            // Initialize the RESTMessageV2 to make a PATCH request to SCIM API
            var restMessage = new sn_ws.RESTMessageV2();
            restMessage.setEndpoint(scimUserUrl);
            restMessage.setHttpMethod('PATCH');
            restMessage.setRequestHeader('Authorization', 'Bearer ' + gs.getProperty('x_1539348_so.scim.api.token'));
            restMessage.setRequestBody(JSON.stringify(patchPayload));

            var responseResult = restMessage.execute();
            var statusCode = responseResult.getStatusCode();
            var responseBody = responseResult.getBody();

            // Check the response
            if (statusCode == 200) {
                response.success = true;
                response.message = 'Role added to user successfully.';
            } else {
                response.message = 'Failed with status: ' + statusCode + '. ' + responseBody;
            }
        } catch (e) {
            response.message = 'Error: ' + e.message;
            gs.error('Error while adding role to user: ' + e.message);
        }

        return JSON.stringify(response);
    }
});
]]></script>
        <sys_class_name>sys_script_include</sys_class_name>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2024-12-12 10:03:48</sys_created_on>
        <sys_id>98fb1fe3839212103a32ffc6feaad3a9</sys_id>
        <sys_mod_count>53</sys_mod_count>
        <sys_name>SCIMUserService </sys_name>
        <sys_package display_value="so" source="x_1539348_so">e2787a38830652103a32ffc6feaad3bd</sys_package>
        <sys_policy/>
        <sys_scope display_value="so">e2787a38830652103a32ffc6feaad3bd</sys_scope>
        <sys_update_name>sys_script_include_98fb1fe3839212103a32ffc6feaad3a9</sys_update_name>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2024-12-25 22:43:31</sys_updated_on>
    </sys_script_include>
    <sys_es_latest_script action="INSERT_OR_UPDATE">
        <id>98fb1fe3839212103a32ffc6feaad3a9</id>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2024-12-12 10:03:48</sys_created_on>
        <sys_id>0bdc97e3839212103a32ffc6feaad3ce</sys_id>
        <sys_mod_count>0</sys_mod_count>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2024-12-12 10:03:48</sys_updated_on>
        <table>sys_script_include</table>
        <use_es_latest>true</use_es_latest>
    </sys_es_latest_script>
</record_update>
